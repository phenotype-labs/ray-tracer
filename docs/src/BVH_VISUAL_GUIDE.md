# BVH Visual Guide - How It Actually Works

## 1. Scene Setup - Loading ALL Objects

### YES - All objects are loaded into memory at once

```
Scene with 10M triangles:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAM Memory (764 MB)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Triangle Array [10,000,000]        â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”      â”‚
â”‚  â”‚ Tâ‚€â”‚ Tâ‚â”‚ Tâ‚‚â”‚ Tâ‚ƒâ”‚ ... â”‚Tâ‚‰â‚˜â”‚      â”‚ 762 MB
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  BVH Tree [19,999 nodes]            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Nâ‚€ â”‚ Nâ‚ â”‚ Nâ‚‚ â”‚ ... â”‚Nâ‚â‚‰â‚–â”‚      â”‚ 1.22 MB
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Key Point: BVH doesn't duplicate triangles!
- Triangle data: stored ONCE
- BVH nodes: store INDICES pointing to triangles
- Total memory: Triangles + Small BVH overhead
```

## 2. Spatial Partitioning - How BVH Organizes Space

### Example Scene (Top-Down View)

```
Scene with 16 triangles:

     Y
     â†‘
     â”‚
 10  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    â–³     â–³                       â”‚
     â”‚  â–³    â–³        â–³                 â”‚
     â”‚                   â–³     â–³        â”‚
  5  â”‚                                  â”‚
     â”‚         â–³  â–³                     â”‚
     â”‚                         â–³        â”‚
     â”‚  â–³                               â”‚
  0  â”‚            â–³  â–³    â–³     â–³       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â†’ X
     0           5          10

Triangles clustered in space (not uniform)
```

### Step 1: Build Root Bounding Box

```
     Y
     â†‘
 10  â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
     â•‘    â–³     â–³                      â•‘
     â•‘  â–³    â–³        â–³                â•‘
     â•‘                   â–³     â–³       â•‘  ROOT
  5  â•‘                                 â•‘  AABB
     â•‘         â–³  â–³                    â•‘  (All 16)
     â•‘                         â–³       â•‘
     â•‘  â–³                              â•‘
  0  â•‘            â–³  â–³    â–³     â–³      â•‘
     â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜â†’ X
     0           5          10
```

### Step 2: SAH Split - Find Best Division

```
Try splitting on X-axis at different positions:

Split at X=3:
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3 â”‚     13      â”‚  Cost: bad (unbalanced)
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Split at X=5:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8   â”‚    8     â”‚  Cost: good! (balanced)
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Split at X=7:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚    10    â”‚  6   â”‚  Cost: ok (less balanced)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

SAH Formula:
Cost = Area(Left) Ã— Count(Left) + Area(Right) Ã— Count(Right)

Winner: X=5 split
```

### Step 3: Recursive Split Result

```
     Y                    BVH Tree Structure:
     â†‘
 10  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    â–³   â–³ â•‘                      â”‚              â”‚  Root   â”‚
     â”‚  â–³    â–³  â•‘      â–³               â”‚              â”‚ [0-15]  â”‚
     â”‚          â•‘         â–³     â–³      â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
  5  â”‚          â•‘                      â”‚                   â”‚
     â”‚         â–³â•‘ â–³                    â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚          â•‘                â–³     â”‚          â”‚                 â”‚
     â”‚  â–³       â•‘                      â”‚      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”         â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
  0  â”‚          â•‘    â–³  â–³    â–³     â–³  â”‚      â”‚ Left  â”‚         â”‚ Right â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ [0-7] â”‚         â”‚ [8-15]â”‚
     0      5   â”‚       10                    â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”¬â”€â”€â”€â”˜
                â”‚                                 â”‚                 â”‚
         Split Line                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                                          â”‚               â”‚   â”‚           â”‚
                                      â”Œâ”€â”€â”€â–¼â”€â”€â”        â”Œâ”€â”€â–¼â”€â”€â”€â–¼â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”
                                      â”‚Leaf  â”‚        â”‚ Leaf   â”‚     â”‚Leaf  â”‚
                                      â”‚[0-3] â”‚        â”‚ [4-7]  â”‚     â”‚[8-15]â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”˜
```

## 3. BVH Tree Structure - Complete Example

### Small Scene: 12 Triangles

```
Tree (binary):

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚         Root Node            â”‚
                        â”‚  AABB: (-10,-10) â†’ (10,10)  â”‚
                        â”‚  Primitives: ALL (12)        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Left Child    â”‚              â”‚  Right Child    â”‚
         â”‚ AABB: (-10,-10) â”‚              â”‚ AABB: (0,-10)   â”‚
         â”‚    â†’ (0,10)     â”‚              â”‚    â†’ (10,10)    â”‚
         â”‚ Primitives: 6   â”‚              â”‚ Primitives: 6   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚              â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  LEAF   â”‚      â”‚  LEAF   â”‚    â”‚  LEAF   â”‚      â”‚  LEAF   â”‚
    â”‚[T0,T1,T2â”‚      â”‚[T3,T4,T5â”‚    â”‚[T6,T7,T8â”‚      â”‚[T9,T10, â”‚
    â”‚   ]     â”‚      â”‚   ]     â”‚    â”‚   ]     â”‚      â”‚  T11]   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Each leaf: 3-4 triangles (configurable MAX_LEAF_SIZE)
```

### Memory Layout

```
Flat Array Representation (GPU-friendly):

Index â”‚ Type     â”‚ AABB Min      â”‚ Count â”‚ AABB Max      â”‚ Offset
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€
  0   â”‚ Internal â”‚ (-10,-10,-10) â”‚   0   â”‚ (10,10,10)    â”‚   2    â† Right child at index 2
  1   â”‚ Internal â”‚ (-10,-10,-10) â”‚   0   â”‚ (0,10,10)     â”‚   4    â† Left subtree
  2   â”‚ Internal â”‚ (0,-10,-10)   â”‚   0   â”‚ (10,10,10)    â”‚   6    â† Right subtree
  3   â”‚ Leaf     â”‚ (-10,-5,-5)   â”‚   3   â”‚ (-5,0,0)      â”‚   0    â† Triangles [0,1,2]
  4   â”‚ Leaf     â”‚ (-5,-5,-5)    â”‚   3   â”‚ (0,5,5)       â”‚   3    â† Triangles [3,4,5]
  5   â”‚ Leaf     â”‚ (0,-5,-5)     â”‚   3   â”‚ (5,5,5)       â”‚   6    â† Triangles [6,7,8]
  6   â”‚ Leaf     â”‚ (5,-5,-5)     â”‚   3   â”‚ (10,10,10)    â”‚   9    â† Triangles [9,10,11]

Linear traversal: No recursion needed!
Cache-friendly: Sequential memory access
```

## 4. Ray Traversal - Step by Step

### Scene Setup

```
Ray shooting from left to right:

     Y
     â†‘
 10  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    â–³   â–³ â•‘                      â”‚
     â”‚  â–³    â–³  â•‘      â–³               â”‚
     â”‚          â•‘         â–³     â–³      â”‚
  5  â•‘â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚ â† Ray @ Y=5
     â”‚         â–³â•‘ â–³                    â”‚
     â”‚          â•‘                â–³     â”‚
     â”‚  â–³       â•‘                      â”‚
  0  â”‚          â•‘    â–³  â–³    â–³     â–³  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â†’ X
     0      5   â”‚       10

Ray: origin=(0,5,0), direction=(1,0,0)
```

### Traversal Animation

#### Step 1: Test Root AABB

```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘            ROOT NODE              â•‘
â•‘  AABB: (-10,-10) â†’ (10,10)       â•‘
â•‘                                   â•‘
â•‘  Ray Test: HIT! âœ“                â•‘
â•‘  â†’ Recurse to children            â•‘
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜

AABB test:
  tmin = (bounds.min - ray.origin) / ray.dir
  tmax = (bounds.max - ray.origin) / ray.dir

  X: [-10 to 10] / (1,0,0) â†’ t âˆˆ [-10, 10]
  Y: [-10 to 10] at y=5    â†’ t âˆˆ [-âˆ, âˆ]

  Intersection: YES (t âˆˆ [0, 10])
```

#### Step 2: Test Left Child

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LEFT CHILD   â”‚
â”‚ (-10,-10)â†’(0,10)
â”‚               â”‚
â”‚  Ray Test:    â”‚
â”‚  HIT! âœ“       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º
â”‚  â†’ Continue   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Intersection at X âˆˆ [-10, 0]
Ray enters at X=0
```

#### Step 3: Test Right Child

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   RIGHT CHILD    â”‚
                â”‚ (0,-10)â†’(10,10) â”‚
                â”‚                  â”‚
                â”‚  Ray Test:       â”‚
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º  HIT! âœ“         â”‚
                â”‚  â†’ Continue      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Intersection at X âˆˆ [0, 10]
Ray enters immediately at X=0
```

#### Step 4: Test Left-Left Leaf

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ LEAF â”‚
â”‚[T0,T1â”‚
â”‚ ,T2] â”‚
â”‚      â”‚
â”‚ MISS â”‚ X (Below ray)
â””â”€â”€â”€â”€â”€â”€â”˜

AABB: Y âˆˆ [-10, 2]
Ray: Y = 5
No intersection!
SKIP all 3 triangles â† PRUNING!
```

#### Step 5: Test Left-Right Leaf

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ LEAF â”‚
â”‚[T3,T4â”‚
â”‚ ,T5] â”‚  â•â•â•â•â•â–º HIT! Test triangles
â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”˜

AABB: Y âˆˆ [3, 7]
Ray: Y = 5
YES! Test each triangle:
  T3: MISS
  T4: HIT at t=3.5 âœ“ â† Found intersection!
  T5: MISS
```

#### Step 6: Test Right Side (for closer hit)

```
                â”Œâ”€â”€â”€â”€â”€â”€â”
                â”‚ LEAF â”‚
                â”‚[T6,T7â”‚
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º,T8]  â”‚
                â”‚      â”‚
                â””â”€â”€â”€â”€â”€â”€â”˜

Found hit at t=3.5
These AABBs start at t=5.0
SKIP - can't be closer! â† EARLY TERMINATION
```

### Traversal Summary

```
Total Tests:
âœ“ Root AABB        (1 test)
âœ“ Left AABB        (1 test)
âœ“ Right AABB       (1 test)
âœ— Left-Left AABB   (1 test, pruned)
âœ“ Left-Right AABB  (1 test)
  â””â”€ T3, T4, T5    (3 triangle tests)
âœ— Right children   (pruned, too far)

Total: 5 AABB + 3 triangle = 8 tests
vs Linear: 12 triangle tests

Savings: 33% fewer tests (scales to 99.9% at 1M triangles!)
```

## 5. Massive Scene Example - 1 Million Triangles

### Spatial Distribution

```
     Y (100 units)
     â†‘
 100 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ âˆ´âˆ´âˆ´     âˆ´âˆ´âˆ´âˆ´âˆ´              âˆ´âˆ´âˆ´         â”‚
     â”‚    âˆ´âˆ´âˆ´âˆ´           âˆ´âˆ´âˆ´âˆ´   âˆ´âˆ´âˆ´âˆ´          â”‚
  80 â”‚         âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´              âˆ´âˆ´âˆ´âˆ´âˆ´ â”‚
     â”‚  âˆ´âˆ´âˆ´                âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´          â”‚
     â”‚      âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´     âˆ´âˆ´âˆ´âˆ´                 â”‚
  60 â”‚                                    âˆ´âˆ´âˆ´âˆ´ â”‚
     â”‚ âˆ´âˆ´âˆ´âˆ´                âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´           â”‚
     â”‚        âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´                 âˆ´âˆ´âˆ´  â”‚
  40 â”‚                  âˆ´âˆ´âˆ´âˆ´âˆ´        âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´  â”‚
     â”‚   âˆ´âˆ´âˆ´âˆ´âˆ´                               â”‚
     â”‚           âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´    âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´         â”‚
  20 â”‚                                âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´ â”‚
     â”‚ âˆ´âˆ´âˆ´âˆ´âˆ´                                  â”‚
     â”‚      âˆ´âˆ´âˆ´âˆ´âˆ´        âˆ´âˆ´âˆ´âˆ´âˆ´âˆ´    âˆ´âˆ´âˆ´       â”‚
   0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â†’ X
     0    20    40    60    80   100

Each âˆ´ represents ~10,000 triangles
Clustered distribution (realistic model)
```

### BVH Tree Depth

```
Level 0 (Root):              [1 node]           1M triangles
                                 â”‚
Level 1:                    [2 nodes]          500K each
                            â•±         â•²
Level 2:                [4 nodes]            250K each
                      â•±   â•²       â•±   â•²
Level 3:          [8 nodes]              125K each
                 ...
Level 14:    [16,384 nodes]                ~61 triangles
                 ...
Level 15:    [10,000 leaf nodes]           100 triangles each

Depth = logâ‚‚(1M / 100) = logâ‚‚(10K) â‰ˆ 15 levels
```

### Single Ray Traversal Path

```
Typical ray path through 1M triangle BVH:

Level  â”‚ Nodes    â”‚ Tests   â”‚ Action
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0    â”‚    1     â”‚    1    â”‚ Test root â†’ HIT
  1    â”‚    1     â”‚    1    â”‚ Test left child â†’ HIT
  2    â”‚    1     â”‚    1    â”‚ Test right child â†’ HIT
  3    â”‚    1     â”‚    1    â”‚ Test right â†’ HIT
  4    â”‚    1     â”‚    1    â”‚ Test left â†’ HIT
  ...  â”‚   ...    â”‚   ...   â”‚ ...
 14    â”‚    1     â”‚    1    â”‚ Test left â†’ HIT
 15    â”‚ LEAF (1) â”‚  100    â”‚ Test 100 triangles
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:               115 tests

Linear scan:      1,000,000 tests
Speedup:          8,695x

Actual speedup: ~374x (cache misses, AABB overhead)
```

## 6. Memory Layout Comparison

### Array of Structures (Bad)

```
struct Triangle {
    v0: Vec3,      // 12 bytes
    v1: Vec3,      // 12 bytes
    v2: Vec3,      // 12 bytes
    uv0: [f32;2],  //  8 bytes
    uv1: [f32;2],  //  8 bytes
    uv2: [f32;2],  //  8 bytes
    material: u32, //  4 bytes
    _pad: u32,     //  4 bytes
}  // Total: 68 bytes

Cache line (64 bytes): Less than 1 triangle!

Memory access:
[T0_v0,v1,v2,uv...][T1_v0,v1,v2,uv...][T2...]
     â””â”€ 64 bytes â”€â”˜
Need all data for 1 triangle,
but only test positions!
```

### Structure of Arrays (Good)

```
struct TriangleMesh {
    positions: Vec<[Vec3; 3]>,  // Tightly packed
    uvs: Vec<[[f32;2]; 3]>,     // Separate
    materials: Vec<u32>,        // Separate
}

Cache line (64 bytes): 5+ triangle positions!

Memory access:
[T0_v0,v1,v2][T1_v0,v1,v2][T2_v0,v1,v2][T3...]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 64 bytes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Load only what you need for intersection!
UVs/materials: loaded AFTER hit is found
```

### Cache Efficiency Example

```
Test 1000 triangles:

AoS (Bad):
Cache lines: 1000 (one per triangle)
Wasted bytes: ~40% (loading unused UV/material data)
Cache misses: ~800

SoA (Good):
Cache lines: 200 (5 triangles per line)
Wasted bytes: ~5% (alignment only)
Cache misses: ~50

Speedup: 16x fewer cache misses!
```

## 7. Build Process - SAH in Action

### Example: 8 Triangles

```
Initial state (unsorted):
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ Tâ‚€â”‚ Tâ‚â”‚ Tâ‚‚â”‚ Tâ‚ƒâ”‚ Tâ‚„â”‚ Tâ‚…â”‚ Tâ‚†â”‚ Tâ‚‡â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

Positions:
Tâ‚€: (1,5)  Tâ‚: (3,7)  Tâ‚‚: (2,3)  Tâ‚ƒ: (8,9)
Tâ‚„: (7,2)  Tâ‚…: (9,4)  Tâ‚†: (4,6)  Tâ‚‡: (6,1)
```

### SAH Binning (X-axis, 4 buckets)

```
Range: X âˆˆ [1, 9], bucket width = 2

Bucket 0 (X: 1-3):  Tâ‚€(1,5), Tâ‚(3,7), Tâ‚‚(2,3)      Count: 3
Bucket 1 (X: 3-5):  Tâ‚†(4,6)                         Count: 1
Bucket 2 (X: 5-7):  Tâ‚‡(6,1)                         Count: 1
Bucket 3 (X: 7-9):  Tâ‚ƒ(8,9), Tâ‚„(7,2), Tâ‚…(9,4)      Count: 3

Sweep splits:
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  3  â”‚  1  â”‚  1  â”‚  3  â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

Split after bucket 1:
  Left:  [Tâ‚€,Tâ‚,Tâ‚‚,Tâ‚†] = 4 triangles
  Right: [Tâ‚‡,Tâ‚ƒ,Tâ‚„,Tâ‚…] = 4 triangles
  Cost: Area(Left)Ã—4 + Area(Right)Ã—4 = BEST!
```

### Partition Result

```
After partitioning on X=5:

Left child:                  Right child:
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”           â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ Tâ‚€â”‚ Tâ‚â”‚ Tâ‚‚â”‚ Tâ‚†â”‚           â”‚ Tâ‚‡â”‚ Tâ‚ƒâ”‚ Tâ‚„â”‚ Tâ‚…â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜           â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  X âˆˆ [1,4]                   X âˆˆ [6,9]

Recursively split each side!
```

## 8. Real Performance - Why It Works

### 10M Triangles Benchmark Breakdown

```
Operation Timeline (100K rays):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BVH Build: 7.90 seconds                        â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ               â”‚
â”‚                                                â”‚
â”‚ - Compute AABBs: 0.8s                          â”‚
â”‚ - SAH splits: 6.2s                             â”‚
â”‚ - Tree construction: 0.9s                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ray Tracing: 2.04 seconds                      â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                       â”‚
â”‚                                                â”‚
â”‚ Per ray average:                               â”‚
â”‚ - AABB tests: ~200 (3 Î¼s)                      â”‚
â”‚ - Triangle tests: ~150 (15 Î¼s)                 â”‚
â”‚ - Total: ~20 Î¼s per ray                        â”‚
â”‚                                                â”‚
â”‚ Throughput: 50K rays/sec                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total: 10.0 seconds to render 100K rays through 10M triangles!

vs Linear: 100K rays Ã— 10M triangles Ã— 30 ops = 30 trillion ops
         â‰ˆ 10,000 seconds @ 3GHz = 2.7 HOURS!
```

### Why BVH is 374x Faster

```
Factors:
1. Hierarchical Pruning:    ~588x (theoretical)
2. Cache Locality:           ~3x boost
3. AABB Overhead:           Ã·5x cost
4. Early Termination:        ~2x boost

Combined: 588 Ã— 3 Ã— 2 Ã· 5 â‰ˆ 706x theoretical
Actual: 374x (branch mispredictions, memory bandwidth)

Still incredible!
```

The **key insight**: Load everything once, organize spatially, prune hierarchically. That's how you handle 10 million triangles in real-time! ğŸš€
